name: Lighthouse – Comment

# Posts the Lighthouse report as a PR comment
# Automatically triggered when "Lighthouse – Run" workflow completes
on:
  workflow_run:
    workflows: ["Lighthouse – Run"]
    types:
      - completed

permissions:
  issues: write
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Lighthouse comment artifact
        id: download-artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-comment
          path: .
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure comment file exists
        if: steps.download-artifact.outcome == 'success'
        run: test -f lighthouse-comment.md

      - name: Get PR number
        if: steps.download-artifact.outcome == 'success'
        id: pr
        run: |
          PR_NUMBER=$(jq -r '.pull_requests[0].number' <<< '${{ toJson(github.event.workflow_run) }}' || echo "")
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Post Lighthouse comment
        if: steps.download-artifact.outcome == 'success' && steps.pr.outputs.number != '' && steps.pr.outputs.number != 'null'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          body-path: lighthouse-comment.md
          edit-mode: replace
